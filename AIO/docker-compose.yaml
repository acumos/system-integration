version: '2'
# ===============LICENSE_START=======================================================
# Acumos Apache-2.0
# ===================================================================================
# Copyright (C) 2017-2018 AT&T Intellectual Property & Tech Mahindra. All rights reserved.
# ===================================================================================
# This Acumos software file is distributed by AT&T and Tech Mahindra
# under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# This file is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ===============LICENSE_END=========================================================

# docker-compose for all-in-one environment
# uses localhost for database (running on same server)
# TODO: remove ports: for services that do not need external exposure
# TODO: remove or parameterize all credentials
# TODO: scrub all attributes for current need
services:
   nexus:
       image: sonatype/nexus3:3.9.0
       ports:
           - ${ACUMOS_NEXUS_API_PORT}:8081
           - ${ACUMOS_MAVEN_MODEL_PORT}:${ACUMOS_MAVEN_MODEL_PORT}
           - ${ACUMOS_DOCKER_MODEL_PORT}:${ACUMOS_DOCKER_MODEL_PORT}
           - ${ACUMOS_DOCKER_PLATFORM_PORT}:${ACUMOS_DOCKER_PLATFORM_PORT}
       volumes:
           - acumos-logs:/maven/logs
       logging:
           driver: json-file

   common-data-svc:
       image: ${COMMON_DATASERVICE_IMAGE}
       environment:
           SPRING_APPLICATION_JSON: "{
                \"server\" : {
                    \"port\" : ${ACUMOS_CDS_PORT}
                },
                \"security\" : {
                    \"user\" : {
                        \"name\"     : \"${ACUMOS_CDS_USER}\",
                        \"password\" : \"${ACUMOS_CDS_PASSWORD}\"
                    }
                },
                \"spring\" : {
                    \"database\" : {
                        \"driver\" : {
                            \"classname\" : \"org.mariadb.jdbc.Driver\"
                        }
                    },
                    \"datasource\" : {
                        \"url\" : \"jdbc:mysql://${ACUMOS_MARIADB_HOST}:${ACUMOS_MARIADB_PORT}/$ACUMOS_CDS_DB?useSSL=false\",
                        \"username\" : \"acumos_opr\",
                        \"password\" : \"${MARIADB_USER_PASSWORD}\"
                    },
                    \"jpa\" : {
                        \"database-platform\" : \"org.hibernate.dialect.MySQLDialect\",
                        \"hibernate\" : {
                            \"ddl-auto\" : \"validate\"
                        }
                   }
                 }
           }"
       expose:
           - ${ACUMOS_CDS_PORT}
# Use of ports here is temporary, for creation of an admin role through the swagger
# API interface, at http://<portal IP>:${ACUMOS_CDS_PORT}/ccds/swagger-ui.html
       ports:
           - ${ACUMOS_CDS_PORT}:${ACUMOS_CDS_PORT}
       volumes:
           - acumos-logs:/maven/logs
       logging:
           driver: json-file

   onboarding-app:
       image: ${ONBOARDING_IMAGE}
       environment:
          SPRING_APPLICATION_JSON: "{
               \"server\" :{
                    \"port\" : ${ACUMOS_ONBOARDING_PORT}
                },
               \"docker\" : {
                   \"host\" : \"${ACUMOS_DOCKER_API_HOST}\",
                   \"port\" : 4243,
                   \"config\": \"/docker_host/.docker\",
                   \"registry\" :{
                       \"url\": \"http://nexus:${ACUMOS_DOCKER_MODEL_PORT}/\",
                       \"username\" : \"acumos_rw\",
                       \"password\" : \"${ACUMOS_RW_USER_PASSWORD}\",
                       \"email\": \"acumos@example.com\"
                   },
                   \"tls\": {
                       \"verify\": \"false\"
                   },
                   \"api\": {
                       \"version\": \"1.23\"
                   },
                   \"imagetag\": {
                       \"prefix\": \"nexus:${ACUMOS_DOCKER_MODEL_PORT}\"
                   },
                   \"max_total_connections\": \"1\",
                   \"max_per_route_connections\": \"1\"
               },
               \"http_proxy\": \"\",
               \"nexus\": {
                       \"nexusEndPointURL\": \"http://nexus:${ACUMOS_NEXUS_API_PORT}/repository/acumos_model_maven/\",
                       \"nexusUserName\": \"acumos_rw\",
                       \"nexusPassword\": \"${ACUMOS_RW_USER_PASSWORD}\",
                       \"nexusproxy\": \"\",
                       \"nexusGroupId\": \"com.artifact\"
               },
               \"cmndatasvc\": {
                       \"cmnDataSvcEndPoinURL\": \"http://common-data-svc:${ACUMOS_CDS_PORT}/ccds\",
                       \"cmnDataSvcUser\": \"${ACUMOS_CDS_USER}\",
                       \"cmnDataSvcPwd\": \"${ACUMOS_CDS_PASSWORD}\"
               },
               \"mktPlace\": {
                    \"mktPlaceEndPoinURL\" : \"http://acumos-portal-be:${ACUMOS_PORTAL_BE_PORT}\"
               },
               \"requirements\": {
                       \"extraIndexURL\": \"http://${PYTHON_EXTRAINDEX_HOST}:8087/archive\",
                       \"trustedHost\": \"${PYTHON_EXTRAINDEX_HOST}\"
               },
               \"authenticationServiceURL\": \"http://acumos-portal-be:${ACUMOS_PORTAL_BE_PORT}\"
       }"
       ports:
           - ${ACUMOS_ONBOARDING_PORT}:${ACUMOS_ONBOARDING_PORT}
       links:
           - common-data-svc
       depends_on:
           - common-data-svc
       volumes:
           - acumos-logs:/maven/logs
           - acumos-output:/temp/
       logging:
           driver: json-file

   acumos-portal-be:
       image: ${PORTAL_BE_IMAGE}
       environment:
           SPRING_APPLICATION_JSON: "{
                \"server\" : {
                   \"port\" : ${ACUMOS_PORTAL_BE_PORT}
                },
                \"nexus\": {
                        \"url\": \"http://nexus:${ACUMOS_NEXUS_API_PORT}/repository/acumos_model_maven/\",
                        \"proxy\": \"\",
                        \"password\": \"${ACUMOS_RW_USER_PASSWORD}\",
                        \"username\": \"acumos_rw\",
                        \"groupid\": \"com.artifact\"
                },
                \"cdms\" : {
                  \"client\" : {
                     \"url\": \"http://common-data-svc:${ACUMOS_CDS_PORT}/ccds\",
                     \"username\": \"${ACUMOS_CDS_USER}\",
                     \"password\": \"${ACUMOS_CDS_PASSWORD}\"
                     }
                },
                \"docker\" : {
                   \"host\" : \"${ACUMOS_DOCKER_API_HOST}\",
                   \"resgistry\" : {
                      \"url\": \"http://nexus:${ACUMOS_DOCKER_MODEL_PORT}/\",
                      \"username\" : \"acumos_rw\",
                      \"password\" : \"${ACUMOS_RW_USER_PASSWORD}\",
                      \"email\": \"acumos@example.com\"
                   },
                   \"imagetag\" : {
                       \"prefix\": \"nexus:${ACUMOS_DOCKER_MODEL_PORT}\"
                   }
                },
                \"qanda\" : {
                   \"url\" : \"http://acumos-cms:${ACUMOS_CMS_PORT}\"
                },
                \"onboarding\" : {
                   \"push\" : {
                       \"model\" : {
                          \"url\" : \"http://onboarding-app:${ACUMOS_ONBOARDING_PORT}/onboarding-app/v2/models\"
                       }
                   }
                },
                \"model\" : {
                   \"storage\" : {
                      \"folder\" : {
                         \"name\" : \"/acumosWebOnboarding\"
                      }
                   }
                },
                \"doc\" : {
                   \"url\" : \"https://wiki.acumos.org\"
                },
                \"portal\" : {
                   \"feature\" : {
                      \"validateModel\" : \"false\"
                   },
                   \"submitValidation\" : {
                      \"api\" : \"http://wrapper:${ACUMOS_WRAPPER_PORT}/status/v1.0/tasks\"
                   }
                }
           }"
       expose:
           - ${ACUMOS_PORTAL_BE_PORT}
       links:
           - common-data-svc
       depends_on:
           - common-data-svc
       volumes:
           - acumos-logs:/maven/logs
           - acumosWebOnboarding:/acumosWebOnboarding
       logging:
           driver: json-file

   acumos-portal-fe:
       image: ${PORTAL_FE_IMAGE}
       environment:
           SPRING_APPLICATION_JSON: "{
               \"server\" : {
                    \"port\" : ${ACUMOS_PORTAL_FE_PORT}
                },
               \"zuul\" : {
                   \"routes\" : {
                      \"api\" : {
                        \"url\": \"http://acumos-portal-be:${ACUMOS_PORTAL_BE_PORT}\"
                      },
                      \"dsce\": {
                        \"url\": \"http://ds-compositionengine:${ACUMOS_DSCE_PORT}\"
                      },
                      \"site\" : {
                        \"url\": \"http://acumos-cms:${ACUMOS_CMS_PORT}\"
                      },
                      \"cmnt\" : {
                         \"url\" : \"http://delete-me:${ACUMOS_PLATON_PORT}\"
                      },
                      \"azure\" : {
                          \"url\" : \"http://azure-client:${ACUMOS_AZURE_CLIENT_PORT}\"
                      }
                   }
               },
               \"spring\" : {
                  \"http\" : {
                     \"multipart\" : {
                        \"max-file-size\": -1,
                        \"max-request-size\": -1
                     }
                  }
               }
           }"
       ports:
           - ${ACUMOS_PORTAL_FE_PORT}:${ACUMOS_PORTAL_FE_PORT}
       links:
           - acumos-portal-be
       depends_on:
           - acumos-portal-be
       volumes:
           - acumos-logs:/maven/logs
       logging:
           driver: json-file

   ds-compositionengine:
       image: ${DESIGNSTUDIO_IMAGE}
       environment:
           SPRING_APPLICATION_JSON: "{
                          \"server\": {
                                \"port\": ${ACUMOS_DSCE_PORT}
                          },
                          \"dateformat\": \"yyyy-MM-dd-HH-mm-ss-SSS\",
                          \"lib\":\"/maven/\",
                          \"tosca\": {
                                \"outputfolder\": \"/temp/output/\"
                          },
                          \"nexus\": {
                                \"nexusendpointurl\": \"http://nexus:${ACUMOS_NEXUS_API_PORT}/repository/acumos_model_maven/\",
                                \"nexusproxy\": \"\",
                                \"nexuspassword\": \"${ACUMOS_RW_USER_PASSWORD}\",
                                \"nexususername\": \"acumos_rw\",
                                \"nexusgroupid\": \"com.artifact\"
                          },
                          \"cmndatasvc\": {
                                \"cmndatasvcendpoinurl\": \"http://common-data-svc:${ACUMOS_CDS_PORT}/ccds\",
                                \"cmndatasvcuser\": \"${ACUMOS_CDS_USER}\",
                                \"cmndatasvcpwd\": \"${ACUMOS_CDS_PASSWORD}\"
                          },
                          \"docker\": {
                                \"host\": \"${ACUMOS_DOCKER_API_HOST}\",
                                \"port\": 4243,
                                \"config\": \"/docker_host/.docker\",
                                \"registry\": {
                                        \"url\": \"http://nexus:${ACUMOS_DOCKER_MODEL_PORT}/\",
                                        \"username\": \"acumos_rw\",
                                        \"password\": \"${ACUMOS_RW_USER_PASSWORD}\",
                                        \"email\": \"acumos@example.com\"
                                            },
                                \"tls\": {\"verify\": \"false\"},
                                \"api\": {\"version\": \"1.23\"},
                                \"imagetag\": {
                                        \"prefix\": \"nexus:${ACUMOS_DOCKER_MODEL_PORT}\"
                                            },
                                \"max_total_connections\": \"1\",
                                \"max_per_route_connections\": \"1\"
                            }

                        }"
       expose:
           - ${ACUMOS_DSCE_PORT}
       volumes:
           - acumos-logs:/maven/logs
           - acumos-output:/temp/
       logging:
           driver: json-file

   acumos-cms:
       image: ${PORTAL_CMS_IMAGE}
       environment:
           SPRING_APPLICATION_JSON: "{
                \"server\" : {
                    \"port\" : ${ACUMOS_CMS_PORT}
                },
                \"spring\" : {
                    \"datasource\" : {
                        \"url\" : \"jdbc:mysql://${ACUMOS_MARIADB_HOST}:${ACUMOS_MARIADB_PORT}/acumos_cms?useSSL=false\",
                        \"username\" : \"acumos_opr\",
                        \"password\" : \"${MARIADB_USER_PASSWORD}\"
                  }
                },
                \"parameters\": {
                   \"repository\" : {
                      \"dataSource\" : {
                        \"url\" : \"jdbc:mysql://${ACUMOS_MARIADB_HOST}:${ACUMOS_MARIADB_PORT}/acumos_cms?useSSL=false\",
                        \"username\" : \"acumos_opr\",
                        \"password\" : \"${MARIADB_USER_PASSWORD}\"
                      }
                   }
                }
           }"
       expose:
           - ${ACUMOS_CMS_PORT}
       ports:
           - ${ACUMOS_CMS_PORT}:${ACUMOS_CMS_PORT}
       volumes:
           - acumos-logs:/maven/logs
       logging:
           driver: json-file

   federation-gateway:
       image: ${FEDERATION_IMAGE}
       environment:
           SPRING_APPLICATION_JSON: "{
               \"federation\" : {
                    \"instance\" : \"gateway\",
                    \"instance.name\": \"aio\",
                    \"operator\" : \"bc0f5023-79c0-4a99-a7a3-46c83f9ef806\",
                    \"address\" : \"0.0.0.0\",
                    \"server\" : {
                       \"port\" : ${ACUMOS_FEDERATION_PORT}
                    },
                    \"ssl\" : {
                       \"key-store\" : \"/app/certs/acumos_aio.p12\",
                       \"key-store-password\" : \"${ACUMOS_KEYPASS}\",
                       \"key-store-type\" : \"PKCS12\",
                       \"key-password\" : \"${ACUMOS_KEYPASS}\",
                       \"trust-store\" : \"/app/certs/acumosTrustStore.jks\",
                       \"trust-store-password\" : \"${ACUMOS_KEYPASS}\"
                    }
                },
                \"local\" : {
                   \"address\": \"0.0.0.0\",
                   \"server\" : {
                      \"port\" : 9884
                   },
                   \"ssl\" : {
                      \"key-store\" : \"/app/certs/acumos_aio.p12\",
                      \"key-store-password\" : \"${ACUMOS_KEYPASS}\",
                      \"key-store-type\" : \"PKCS12\",
                      \"key-password\" : \"${ACUMOS_KEYPASS}\",
                      \"trust-store\" : \"/app/certs/acumosTrustStore.jks\",
                      \"trust-store-password\" : \"${ACUMOS_KEYPASS}\"
                   }
                },
                \"nexus\": {
                   \"nexusendpointurl\": \"http://nexus:${ACUMOS_NEXUS_API_PORT}/repository/acumos_model_maven/\",
                   \"nexusproxy\": \"\",
                   \"nexuspassword\": \"${ACUMOS_RW_USER_PASSWORD}\",
                   \"nexususername\": \"acumos_rw\",
                   \"nexusgroupid\": \"com.artifact\"
                },
                \"peer\": {
                    \"jobchecker\": {
                        \"interval\": 300
                    }
                },
                \"cdms\" : {
                  \"client\" : {
                     \"url\": \"http://common-data-svc:${ACUMOS_CDS_PORT}/ccds\",
                     \"username\": \"${ACUMOS_CDS_USER}\",
                     \"password\": \"${ACUMOS_CDS_PASSWORD}\"
                  }
                }
           }"
       expose:
           - ${ACUMOS_FEDERATION_PORT}
       ports:
           - ${ACUMOS_FEDERATION_PORT}:${ACUMOS_FEDERATION_PORT}
       links:
           - common-data-svc
       depends_on:
           - common-data-svc
       volumes:
           - acumos-logs:/maven/logs
           - /home/ubuntu/certs:/app/certs
       logging:
           driver: json-file

   filebeat:
       image: ${FILEBEAT_IMAGE}
       volumes:
           - acumos-logs:/filebeat-logs
       environment:
           - LOGSTASH_HOST=acumos-ist-logcollector
           - LOGSTASH_PORT=5601

   acumos-azure-client:
       image: ${AZURE_CLIENT_IMAGE}
       environment:
           SPRING_APPLICATION_JSON: "{
               \"server\" : {
                    \"port\" : ${ACUMOS_AZURE_CLIENT_PORT}
                },
                \"docker\" : {
                    \"containerNamePrefix\": \"acumos-e6e\",
                    \"host\": \"${ACUMOS_DOCKER_API_HOST}\",
                    \"port\": \"4243\",
                    \"dockerVMUserName\": \"dockerUser\",
                    \"dockerVMPassword\": \"12NewPA$$w0rd!\",
                    \"solutionPort\":\"8336\",
                    \"registry\": {
                        \"bluePrint\": {
                            \"username\": \"acumos_ro\",
                            \"password\": \"${ACUMOS_RW_USER_PASSWORD}\"
                        },
                        \"networkgroupName\": \"E6E-NSG\",
                        \"port\": \"80\",
                        \"name\": \"nexus:${ACUMOS_DOCKER_MODEL_PORT}\",
                        \"url\": \"http://nexus:${ACUMOS_DOCKER_MODEL_PORT}/\",
                        \"username\": \"acumos_rw\",
                        \"password\": \"${ACUMOS_RW_USER_PASSWORD}\"
                    }
                },
                \"blueprint\": {
                    \"ImageName\": \"nexus:${ACUMOS_DOCKER_PLATFORM_PORT}/blueprint-orchestrator:1.0.0-SNAPSHOT\",
                    \"name\": \"blueprint-orchestrator\"
                },
                \"nexus\": {
                    \"url\": \"http://nexus:${ACUMOS_NEXUS_API_PORT}/repository/acumos_model_maven/\",
                    \"nexusproxy\": \"\",
                    \"password\": \"${ACUMOS_RW_USER_PASSWORD}\",
                    \"username\": \"acumos_rw\",
                    \"groupId\": \"com.artifact\"
                },
                \"cmndatasvc\": {
                    \"cmndatasvcendpoinurl\": \"http://common-data-svc:${ACUMOS_CDS_PORT}/ccds\",
                    \"cmndatasvcuser\": \"${ACUMOS_CDS_USER}\",
                    \"cmndatasvcpwd\": \"${ACUMOS_CDS_PASSWORD}\"
                }
           }"
       expose:
           - ${ACUMOS_AZURE_CLIENT_PORT}
       volumes:
           - acumos-logs:/maven/logs
       logging:
           driver: json-file

   kong-database:
       restart: on-failure
       image: postgres:9.5
       ports:
         - "${ACUMOS_KONG_DB_PORT}:${ACUMOS_KONG_DB_PORT}"
       environment:
         - POSTGRES_USER=kong
         - POSTGRES_DB=kong
       volumes:
         - kong-db:/var/lib/postgresql

   kong:
       restart: on-failure
       image: kong:0.11
       depends_on:
         - kong-database
       environment:
         - KONG_DATABASE=postgres
         - KONG_PG_HOST=kong-database
         - KONG_PG_DATABASE=kong
         - KONG_PROXY_ACCESS_LOG=/dev/stdout
         - KONG_ADMIN_ACCESS_LOG=/dev/stdout
         - KONG_PROXY_ERROR_LOG=/dev/stderr
         - KONG_ADMIN_ERROR_LOG=/dev/stderr
         - KONG_ADMIN_LISTEN=0.0.0.0:8001
         - KONG_ADMIN_LISTEN_SSL=0.0.0.0:8444
       ports:
         - "${ACUMOS_KONG_PROXY_PORT}:8000"
         - "${ACUMOS_KONG_PROXY_SSL_PORT}:8443"
         - "${ACUMOS_KONG_ADMIN_PORT}:8001"
         - "${ACUMOS_KONG_ADMIN_SSL_PORT}:8444"
       command: >
         /bin/bash -c "
             until [[ $$(curl -v http://kong-database:5432 2>&1 | grep -c \"Connected to \") -gt 0 ]]; do
               echo \"kong-database is unavailable - sleeping 10 seconds\";
               sleep 10;
             done;
             kong migrations up;
             kong start -vv;
             kong health -vv;
             echo Connected!;
         "

# Each persistent volume must be created externally:
#   docker volume create <volume name>
volumes:
    acumos-logs:
        external: true
    acumos-output:
        external: true
    acumosWebOnboarding:
        external: true
    kong-db:
        external: true
